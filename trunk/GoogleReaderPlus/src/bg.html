<html>
    <head>
        <title>readerplus Background</title>
        <script type="text/javascript" src="version.js">
        </script>
        <script type="text/javascript" src="lib/cross.js">
        </script>
        <script type="text/javascript" src="lib/util.js">
        </script>
        <script type="text/javascript" src="lib/external.js">
        </script>
        <script type="text/javascript" src="features.js">
        </script>
        <script type="text/javascript" src="lib/greasekit.js">
        </script>
        <script type="text/javascript" src="api/rest.js">
        </script>
        <script type="text/javascript" src="worker/workerhelper.js">
        </script>
        <script type="text/javascript" src="api/webworkers.js">
        </script>
        <script type="text/javascript" src="api/favicons.js">
        </script>
        <script type="text/javascript" src="http://www.google.com/jsapi">
        </script>
        <script type="text/javascript">
            //var READING_LIST_RE_ = new RegExp('user/[\\d]+/state/com\\.google/reading-list');
            var reReader = {
                reading: /user\/[\d]+\/state\/com\.google\/reading\-list/,
                search: /https?\:\/\/www.google.com\/reader\/view\//,
                url: 'http://www.google.com/reader/view/'
            };
            mycore.extension.onRequest.addListener(onMessageReceived);
            mycore.extension.onRequestExternal.addListener(function(request, sender, sendResponse){
                if (sender.id === GUID_ICON) {
                    onMessageReceived(request, false, sendResponse);
                }
            });
            
            function activePageAction(mprefs){
                //Selective tab for page icon
                chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab){
                    if (reReader.search.test(tab.url)) {
                        var prefs = mprefs || getPrefs();
                        var active = (prefs && prefs.general_pageicon);
                        if (active) {
                            chrome.pageAction.show(tabId);
                            chrome.pageAction.setPopup({
                                tabId: tabId,
                                popup: 'menu/menu.html'
                            });
                            /*chrome.pageAction.onClicked.addListener(function(tab){ });*/
                        } else {
                            chrome.pageAction.hide(tabId);
                        }
                    }
                });
            }
            
            function runStats(mprefs){
                var prefs = mprefs || getPrefs();
                if (prefs && prefs.general_stats) {
                    //initstats();
                }
            }
            
            function runOnSave(mprefs){
                var prefs = mprefs || getPrefs();
				var rc = prefs._replacer_changed;
				delete prefs._replacer_changed;
                monitorIcon(prefs);
                sendPrefsToIcon(prefs);
                activePageAction(prefs);
                runStats(prefs);
				//sure we changed replacer items and click save
				if (mprefs && rc){
					sendToCloud(prefs);
				}
            }

            function sendToCloud(prefs){
                console.log('sendToCloud items...');
                var r = new GRP.api_rest('Replacer', true);
                var cloud_items = mycore.storage.getItem('grp_cloud_Replacer');
                iterate(prefs.replacer_items, function(id, o){
                    var ci = (cloud_items)?cloud_items[id]:false;
                    console.log('sendToCloud '+id);
					r.item.createOrUpdate(ci, {
                        name: id,
                        values: o
                    });
                });
            }
            
            runOnSave();
            
            //request, sender, callback
            function onMessageReceived(a, p, cb){
                if (a.message == "track") {
                    track(a);
                } else if (a.message == "loadicons") {
                    loadIcons(a, cb);
                } else if (a.message == "setprefs") {
                    setPreferences(a);
                    sendNull(cb);
                } else if (a.message == "getprefs") {
                    getPreferences(a, cb);
                } else if (a.message == "openprefs") {
                    open_preferences();
                    sendNull(cb);
                } else if (a.message == "opentab") {
                    open_tab(a);
                    sendNull(cb);
                } else if (a.message == "findreader") {
                    findreader(true, true);
                    sendNull(cb);
                } else if (a.message == "geticon") {
                    extractFavicon(a, cb);
                } else if (a.message == "iconcounter") {
                    monitorIcon();
                } else if (a.message == "request") {
                    request(a, false, cb);
                } else if (a.message == "window") {
                    openwindow(a, cb);
                } else if (a.message == "igtheme") {
                    igtheme(a, cb);
                } else if (a.message == "translate") {
                    translate(a, cb);
                } else if (a.message == "clouddata") {
                    getCloudData(a, cb);
                }
            }
            
            var mappers = {
                def:function(item){
					var o = item.data;
					o.title = o.name;
					return o;
				},
				Replacer: function(item){
                    var o = item.data;
					//title, url,search,replace
					o.title = o.name;
					return o;
                },
                LDRFullFeed: function(item){
                    return {
                        title: item.name,
                        url: item.data.url,
                        search: 'xpath:' + item.data.xpath,
                        replace: "$1"
                    }
                }
            }
            
            function openwindow(a, cb){
                delete a.message;
                chrome.windows.create(a, cb);
            }
            
            function getCloudData(a, cb, mapper){
                request({
                    url: 'http://wedata.net/databases/' + a.name + '/items.json',
                    onload: function(xhr){
                        if (xhr.status == 200) {
                            console.log(a.name + ' get');
                            var items = JSON.parse(xhr.responseText);
                            //cache value
                            var selectors = {};
                            var f = mappers[a.name] || mappers.def;
							foreach(items, function(item){
                                selectors[item.name] = f(item);
                            });
                            //store it now as cache (needs timestamp)
                            mycore.storage.setItem('grp_cloud_' + a.name, selectors);
                            console.log(a.name + ' ok');
                            sendResponse(selectors, cb);
                        }
                    },
                    /*onreadystatechange:function(xhr){
                     console.log('-status:'+ xhr.status);
                     console.log('-readyState:'+ xhr.readyState);
                     },*/
                    onerror: function(){
                        var selectors = mycore.storage.getItem('grp_cloud_' + a.name) || false;
                        sendResponse(selectors, cb);
                    }
                }, true);
            }
            
            
            /**
             * Icon monitor for unreead count
             */
            var monitorId;
            function monitorIcon(mprefs){
                var prefs = mprefs || getPrefs();
                if (prefs && prefs.general_counter) {
                    getUnreadCount();
                    if (monitorId) {
                        window.clearInterval(monitorId);
                    }
                    monitorId = window.setInterval(function(){
                        getUnreadCount();
                    }, 2000);
                }
            }
            
            function sendPrefsToIcon(mprefs){
                var prefs = mprefs || getPrefs();
                call_icon('prefs', {
                    prefs: prefs
                }, function(){
                    //
                });
            }
            
            var lastText, lastLogged;
            function updateIcon(logged, text){
                var refresh = ((!lastLogged || logged !== lastLogged) && (!lastText || text !== lastText));
                refresh = true;
                if (refresh) {
                    var a = {
                        logged: logged,
                        text: text
                    };
                    call_icon('updateicon', a);
                    lastLogged = logged;
                    lastText = text;
                }
            }
            
            var lastTabReader = false;
            monitorCloseTab();
            function monitorCloseTab(){
                //Check if greader were closed
                mycore.tabs.onRemoved.addListener(function(tabId){
                    if (lastTabReader && tabId == lastTabReader.id) {
                        lastTabReader = false;
                    }
                });
            }
            
            function getUnreadCount(){
                if (lastTabReader) {
                    updateFromTabtitle(lastTabReader);
                } else {
                    findreader(false, false, function(tab){
                        if (tab) {
                            lastTabReader = tab;
                            //From tab title
                            updateFromTabtitle(tab);
                        } else {
                            //from xhr (1000+ limitations)
                            request({
                                url: 'http://www.google.com/reader/api/0/unread-count?output=json&client=readerplus&refresh=true',
                                onload: function(xhr){
                                    if (xhr.status == 200) {
                                        var count = parseUnread(xhr.responseText);
                                        var text;
                                        if (lastText && count == 1000) {
                                            //Let the last text since tab wereclosed and xhr cannot tell us more info on count
                                            text = lastText;
                                        } else {
                                            text = formatUnread(count);
                                        }
                                        updateIcon(true, text);
                                    } else {
                                        updateIcon(false, '');
                                    }
                                },
                                onerror: function(o){
                                    updateIcon(false, '');
                                }
                            }, true);
                        }
                    });
                }
            }
            
            function formatUnread(count){
                if (!count) {
                    return '';
                }
                var text = '' + count;
                if (text.length > 4 && text.lenth < 6) {
                    text = text.substring(0, text.length - 3) + "k";
                } else if (count.lenth >= 6) {
                    text = ">1M";
                }
                return text;
            }
            
            function updateFromTabtitle(tab, cb){
                var count = parseTabtitle(tab, function(count){
                    var text = formatUnread(count);
                    updateIcon(true, text);
                });
            }
            
            function parseTabtitle(tb, cb){
                //Needs update data 
                mycore.tabs.get(tb.id, function(tab){
                    var checkurl = /^https?:\/\/www\.google\.com\/reader\/view/.test(tab.url);
                    if (checkurl) {
                        var m = /\((\d+)\+?\)/.exec(tab.title);
                        var text = (m) ? m[1] : '0';
                        cb.call(this, text);
                    } else {
                        tb = false;
                    }
                });
            }
            
            function parseUnread(json){
                //var count = 0, o = eval('(' + json + ')');
                var o = JSON.parse(json);
                //var max = parseInt(o.max, 10);
                //if (max == 1000) {
                for (var i = 0, len = o.unreadcounts.length; i < len; i++) {
                    var f = o.unreadcounts[i];
                    //count += parseInt(f.count, 10);
                    if (reReader.reading.test(f.id)) {
                        count = f.count;
                        continue;
                    }
                }
                /*} else {
                 count = max;
                 }*/
                return count;
            }
            
            function setPrefs(prefs, cleanall){
				mycore.storage.setItem('grp_prefs', prefs);
                if (cleanall) {
                    mycore.storage.setItem('grp_favicons', '');
                }
                runOnSave(prefs);
            }
            
            function setPreferences(a){
                mycore.storage.clear();
                mycore.storage.setItem('grp_version', GRP.VERSION);
                setPrefs(a.prefs, a.cleanall);
            }
            
            function getPrefs(a){
                var id;
                //var textPrefs = localStorage.getItem('grp_prefs');
                //var prefs = (textPrefs) ? JSON.parse(textPrefs) : false;
                var prefs = mycore.storage.getItem('grp_prefs');
                prefs = checkPrefs(prefs);
                return prefs;
            }
            
            function getPreferences(a, cb){
                initVersion();
                var prefs = getPrefs();
                if (cb) {
                    cb.call(this, {
                        message: "prefs",
                        prefs: prefs
                    });
                } else {
                    sendResponse({
                        message: "prefs",
                        prefs: prefs
                    }, cb);
                }
                return prefs;
            }
            
            function checkPrefs(prefs){
                prefs = prefs || {};
                //set default if not
                iterate(GRP.scripts, function(id, script){
                    //options
                    iterate(script.options, function(option, o){
                        if (!(o && typeof o === 'object' && o.label)) {
                            id = script.id + '_' + option;
                            if (typeof prefs[id] === "undefined") {
                                prefs[id] = getTypedValue(o);
                            }
                        }
                    });
                    //shortcuts
                    iterate(script.shortcuts, function(shortcut, o){
                        id = script.id + '_key_' + shortcut;
                        if (typeof prefs[id] === "undefined") {
                            prefs[id] = o;
                        }
                    });
                }, this, true);
                checkIconDomains(prefs);
                return prefs;
            }
            
            function getTypedValue(o){
                var text;
                if (typeof o === 'object') {
                    text = o.value || '';
                } else {
                    text = o;
                }
                if (text === "true") {
                    return true;
                } else if (text === "false") {
                    return false;
                } else {
                    return text;
                }
            }
            
            
            function request(a, local, cb){
                var xhr = new XMLHttpRequest();
                var method = a.method || 'get';
                method = method.toLowerCase();
                var url = a.url;
                if (a.parameters && (method === 'get')) {
                    var params = [];
                    for (var k in a.parameters) {
                        params.push(k + '=' + encodeURIComponent(a.parameters[k]));
                    }
                    var sep = (url.indexOf('?') > 0) ? '&' : '?';
                    url += sep + params.join('&');
                }
                xhr.open(method, url, true);
                //headers
                if (a.headers) {
                    for (var kh in a.headers) {
                        xhr.setRequestHeader(kh, a.headers[kh]);
                    }
                }
                //a['onload']=true;//force onload
                var fns = ['readystatechange', 'error', 'load'];
                var xpath = a.xpath;
                for (var i = 0, len = fns.length; i < len; i++) {
                    var name = fns[i];
                    if (a['on' + name]) {
                        var f = '' + name;
                        xhr['on' + f] = function(o){
                            var xhr = o.target;
                            if (xhr) {
                                if (local && typeof a['on' + f] === "function") {
                                    a['on' + f].call(this, xhr);
                                } else {
                                    var res = {
                                        message: a.callback || "requestdone",
                                        action: f,
                                        responseXML: null, //xhr.responseXML,
                                        responseText: xhr.responseText,
                                        responseHeaders: xhr.responseHeaders,
                                        status: xhr.status,
                                        statusText: xhr.statusText,
                                        request: a
                                    };
                                    if (a.dataType === 'json' && res.responseText) {
                                        try {
                                            res.responseJson = JSON.parse(res.responseText);
                                        } 
                                        catch (e) {
                                        }
                                    }
                                    if (xpath && xhr.responseXML) {
                                        res.xml = serializeXml(getElements(xpath, xhr.responseXML));
                                    }
                                    sendResponse(res, cb);
                                }
                            }
                        };
                    }
                }
                try {
                    var typesSend = {
                        post: true,
                        put: true,
                        'delete': true
                    };
                    var d = typesSend[method] ? a.data : null;
                    if (d && typeof d !== 'string') {
                        d = serializePost(d);
                    }
                    xhr.send(d);
                } 
                catch (e) {
                    console.log('Error catched on xhr');
                    var o = {
                        message: a.callback || "requestdone",
                        responseText: e.message || 'Error',
                        status: (e.name || '') + ' ' + (e.code || 0),
                        statusText: (e.name || '') + ' ' + (e.code || 0),
                        action: 'error',
                        error: e
                    };
                    if (local && typeof a.onerror === "function") {
                        a.onerror.call(this, o);
                    } else {
                        sendResponse(o, cb);
                    }
                }
            }
            
            //Try to find opened tab before open it
            function open_tab(a){
                if (a.search) {
                    var o = {
                        search: new RegExp(a.search.replace(/^https?/, 'https?').replace(/#.*$/, '')),
                        url: a.url
                    };
                    selecttab(o, a.selected, a.create || true, a.fn);
                } else {
                    opentab(a);
                }
            }
            
            function findreader(selected, create, fn){
                selecttab(reReader, selected, create, fn);
            }
            
            function selecttab(a, selected, create, fn){
                findtab(a, function(tab){
                    if (tab) {
                        if (selected) {
                            mycore.tabs.update(tab.id, {
                                url: a.url,
                                selected: true
                            }, function(tab){
                                mycore.tabs.executeScript(tab.id, 'hashchange();');
                            });
                        }
                    } else {
                        if (create) {
                            a.selected = selected;
                            opentab(a);
                        }
                    }
                    if (fn && typeof fn === "function") {
                        fn.call(this, tab);
                    }
                });
            }
            
            function findtab(a, fn){
                mycore.windows.getAll({
                    populate: true
                }, function(windows){
                    var tab = false, found = false;
                    for (var i = 0, len = windows.length; i < len; i++) {
                        var window = windows[i];
                        for (var j = 0, jlen = window.tabs.length; j < jlen; j++) {
                            tab = window.tabs[j];
                            var check = false;
                            if (a.search && a.search.test) {
                                check = (a.search.test(tab.url));
                            } else {
                                check = (tab.url.indexOf(a.search) >= 0);
                            }
                            if (check) {
                                found = true;
                                fn.call(this, tab);
                                break;
                            }
                        }
                    }
                    if (!found) {
                        fn.call(this, false);
                    }
                });
            }
            
            function opentab(a){
                mycore.tabs.getSelected(null, function(tab){
                    var o = {
                        url: a.url,
                        selected: (a.selected || typeof a.selected === "undefined"),
                        windowId: a.windowId,
                        index: a.index || (tab.index + 1)
                    };
                    mycore.tabs.create(o);
                });
            }
            
            function open_preferences(){
                opentab({
                    url: "preferences.html"
                });
            }
            
            function igtheme(o, cb){
                if (o.type === 'random') {
                    //random theme
                    getRandomTheme(o.current, function(entry){
                        prefs = getPrefs();
                        prefs.ig_skin_name = entry.title;
                        prefs.ig_skin_id = entry.skin_id;
                        prefs.ig_skin_url = entry.link;
                        setPrefs(prefs);
                        cb(entry);
                    }, true);
                }
            }
            
            function translate(o, cb){
                function trad(){
                    google.language.translate(o.text, o.from || '', o.to, function(a){
                        cb(a);
                    });
                }
                if (!google.language) {
                    google.load("language", "1", {
                        "callback": trad
                    });
                } else {
                    trad();
                }
            }
            
            function sendResponse(a, cb){
                if (cb) {
                    cb(a);
                } else {
                    //myport.postMessage(a);
                }
            }
            
            function sendNull(cb){
                if (cb) {
                    cb({});
                }
            }
            
            //+favicons_providerpageicons
            function upgrade(){
                var prefs = getPrefs();
                if (prefs) {
                    /*if (prefs.favicons) {
                     prefs.favicons_providerpageicons = true;
                     }*/
                    if (isundef(prefs.general_stats)) {
                        prefs.general_stats = true;
                    }
                    if (isundef(prefs.general_pageicon)) {
                        prefs.general_pageicon = true;
                    }
                    setPrefs(prefs);
                }
            }
            
            function initVersion(){
                var v = mycore.storage.getItem('grp_version');
                if (v === null || v !== GRP.VERSION) {
                    mycore.storage.setItem('grp_version', GRP.VERSION);
                    upgrade();
                    var prefs = getPrefs();
                    if (prefs.general_noupdatepopup === false) {
                        //no popup on minor updates
                        if (isVersionMajorUpdated(v, GRP.VERSION)) {
                            opentab({
                                url: "about.html"
                            });
                        }
                    }
                }
            }
        </script>
        <script type="text/javascript" src="https://ssl.google-analytics.com/ga.js" async="true">
        </script>
        <script type="text/javascript" src="prefs/stats.js">
        </script>
    </head>
    <body>
        <script>
            /*
             (function() {
             var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
             ga.src = 'https://ssl.google-analytics.com/ga.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
             })();
             */
        </script>
    </body>
</html>
